"""Vulnerability CRUD operations."""
from datetime import datetime
from typing import Dict, List, Optional
from uuid import UUID

from sqlalchemy import func
from sqlalchemy.orm import Session

from server.app.models.vulnerability import Vulnerability


def upsert_vulnerability(
    db: Session,
    project_id: UUID,
    target_url: str,
    template_id: str,
    **kwargs,
) -> Vulnerability:
    """Create or update a vulnerability."""
    existing = db.query(Vulnerability).filter(
        Vulnerability.project_id == project_id,
        Vulnerability.target_url == target_url,
        Vulnerability.template_id == template_id,
    ).first()

    if existing:
        for key, value in kwargs.items():
            if value is not None and hasattr(existing, key):
                setattr(existing, key, value)
        existing.last_seen = datetime.utcnow()
        db.commit()
        db.refresh(existing)
        return existing

    vuln = Vulnerability(
        project_id=project_id,
        target_url=target_url,
        template_id=template_id,
        **kwargs,
    )
    db.add(vuln)
    db.commit()
    db.refresh(vuln)
    return vuln


def get_vulnerability(db: Session, vuln_id: UUID) -> Optional[Vulnerability]:
    """Get a vulnerability by ID."""
    return db.query(Vulnerability).filter(Vulnerability.id == vuln_id).first()


def list_vulnerabilities(
    db: Session,
    project_id: UUID,
    severity: Optional[str] = None,
    status: Optional[str] = None,
    template_id: Optional[str] = None,
    skip: int = 0,
    limit: int = 20,
) -> List[Vulnerability]:
    """List vulnerabilities with filters."""
    query = db.query(Vulnerability).filter(Vulnerability.project_id == project_id)

    if severity:
        query = query.filter(Vulnerability.severity == severity)
    if status:
        query = query.filter(Vulnerability.status == status)
    if template_id:
        query = query.filter(Vulnerability.template_id == template_id)

    return query.order_by(Vulnerability.last_seen.desc()).offset(skip).limit(limit).all()


def count_vulnerabilities(
    db: Session,
    project_id: UUID,
    severity: Optional[str] = None,
    status: Optional[str] = None,
    template_id: Optional[str] = None,
) -> int:
    """Count vulnerabilities with filters."""
    query = db.query(func.count(Vulnerability.id)).filter(
        Vulnerability.project_id == project_id
    )

    if severity:
        query = query.filter(Vulnerability.severity == severity)
    if status:
        query = query.filter(Vulnerability.status == status)
    if template_id:
        query = query.filter(Vulnerability.template_id == template_id)

    return query.scalar() or 0


def get_vulnerability_stats(db: Session, project_id: UUID) -> Dict[str, int]:
    """Get vulnerability statistics for a project."""
    stats = {
        "total": 0,
        "critical": 0, "high": 0, "medium": 0, "low": 0, "info": 0,
        "open": 0, "confirmed": 0, "fixed": 0, "false_positive": 0,
    }

    # Single query for both severity and status counts
    rows = (
        db.query(
            Vulnerability.severity,
            Vulnerability.status,
            func.count(Vulnerability.id),
        )
        .filter(Vulnerability.project_id == project_id)
        .group_by(Vulnerability.severity, Vulnerability.status)
        .all()
    )

    for severity, status, count in rows:
        stats["total"] += count
        if severity in stats:
            stats[severity] += count
        if status in stats:
            stats[status] += count

    return stats


def update_vulnerability(
    db: Session,
    vuln_id: UUID,
    status: Optional[str] = None,
    is_false_positive: Optional[bool] = None,
) -> Optional[Vulnerability]:
    """Update a vulnerability status."""
    vuln = get_vulnerability(db, vuln_id)
    if not vuln:
        return None

    if status is not None:
        vuln.status = status
        if status == "confirmed":
            vuln.confirmed_at = datetime.utcnow()
        elif status == "fixed":
            vuln.fixed_at = datetime.utcnow()

    if is_false_positive is not None:
        vuln.is_false_positive = is_false_positive
        if is_false_positive:
            vuln.status = "false_positive"

    db.commit()
    db.refresh(vuln)
    return vuln
