"""Vulnerability model."""
import uuid
from datetime import datetime

from sqlalchemy import (
    Boolean,
    Column,
    DateTime,
    ForeignKey,
    Integer,
    String,
    Text,
)
from sqlalchemy.dialects.postgresql import JSONB, UUID

from server.app.db.base import Base


class Vulnerability(Base):
    """Vulnerability discovered by scanning."""

    __tablename__ = "vulnerability"

    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    project_id = Column(
        UUID(as_uuid=True), ForeignKey("project.id"), nullable=False
    )

    # Target information
    target_url = Column(String(2048), nullable=False)
    target_host = Column(String(255), nullable=True)
    target_ip = Column(String(45), nullable=True)
    target_port = Column(Integer, nullable=True)

    # Vulnerability details
    template_id = Column(String(255), nullable=False)
    template_name = Column(String(512), nullable=True)
    severity = Column(String(20), nullable=False, default="info")
    vuln_type = Column(String(100), nullable=True)

    # Description and evidence
    title = Column(String(512), nullable=True)
    description = Column(Text, nullable=True)
    reference = Column(JSONB, default=list)
    tags = Column(JSONB, default=list)

    # Evidence
    matched_at = Column(String(2048), nullable=True)
    matcher_name = Column(String(255), nullable=True)
    extracted_results = Column(JSONB, default=list)
    curl_command = Column(Text, nullable=True)

    # Request/Response (optional, for debugging)
    request = Column(Text, nullable=True)
    response = Column(Text, nullable=True)

    # Status tracking
    status = Column(String(20), default="open")  # open, confirmed, fixed, false_positive
    is_false_positive = Column(Boolean, default=False)
    confidence = Column(Integer, default=50)  # 0-100 confidence score
    confirmed_at = Column(DateTime(timezone=True), nullable=True)
    fixed_at = Column(DateTime(timezone=True), nullable=True)

    # Metadata
    scanner = Column(String(50), default="nuclei")
    scan_task_id = Column(UUID(as_uuid=True), nullable=True)
    raw_output = Column(JSONB, default=dict)

    # Timestamps
    first_seen = Column(
        DateTime(timezone=True), default=datetime.utcnow, nullable=False
    )
    last_seen = Column(
        DateTime(timezone=True), default=datetime.utcnow, nullable=False
    )
