"""Vulnerability schemas."""
from datetime import datetime
from enum import Enum
from typing import Any, Dict, List, Optional
from uuid import UUID

from pydantic import BaseModel, Field


class Severity(str, Enum):
    """Vulnerability severity levels."""
    critical = "critical"
    high = "high"
    medium = "medium"
    low = "low"
    info = "info"


class VulnStatus(str, Enum):
    """Vulnerability status."""
    open = "open"
    confirmed = "confirmed"
    fixed = "fixed"
    false_positive = "false_positive"


class VulnerabilityCreate(BaseModel):
    """Schema for creating a vulnerability."""
    target_url: str
    template_id: str
    severity: Severity = Severity.info
    title: Optional[str] = None
    description: Optional[str] = None


class VulnerabilityUpdate(BaseModel):
    """Schema for updating a vulnerability."""
    status: Optional[VulnStatus] = None
    is_false_positive: Optional[bool] = None


class VulnerabilityOut(BaseModel):
    """Schema for vulnerability output."""
    id: UUID
    project_id: UUID
    target_url: str
    target_host: Optional[str] = None
    target_ip: Optional[str] = None
    target_port: Optional[int] = None
    template_id: str
    template_name: Optional[str] = None
    severity: str
    vuln_type: Optional[str] = None
    title: Optional[str] = None
    description: Optional[str] = None
    reference: List[str] = Field(default_factory=list)
    tags: List[str] = Field(default_factory=list)
    matched_at: Optional[str] = None
    matcher_name: Optional[str] = None
    extracted_results: List[Any] = Field(default_factory=list)
    status: str
    is_false_positive: bool
    scanner: str
    first_seen: datetime
    last_seen: datetime

    model_config = {"from_attributes": True}


class VulnerabilityDetail(VulnerabilityOut):
    """Schema for vulnerability detail with extra fields."""
    curl_command: Optional[str] = None
    request: Optional[str] = None
    response: Optional[str] = None
    raw_output: Dict[str, Any] = Field(default_factory=dict)
    confirmed_at: Optional[datetime] = None
    fixed_at: Optional[datetime] = None
    scan_task_id: Optional[UUID] = None


class VulnerabilityStats(BaseModel):
    """Schema for vulnerability statistics."""
    total: int = 0
    critical: int = 0
    high: int = 0
    medium: int = 0
    low: int = 0
    info: int = 0
    open: int = 0
    confirmed: int = 0
    fixed: int = 0
    false_positive: int = 0
